# Feature Specification: Form Components (Invoice Editor)

**Feature Branch**: `010-form-components`
**Created**: 2025-11-28
**Status**: Draft
**Roadmap Item**: P0.8.1
**Depends On**: P0.8.0 (Core Primitives Transfer) ✅

_Note: Generated by `/speckit.specify` command per Constitutional Principle XV (SpecKit Workflow Compliance)_

## Overview

Form components for the invoice creation workflow. These components enable users to input wallet addresses, select networks, choose tokens, and manage invoice line items. Components integrate with existing Wagmi/Viem infrastructure for Web3 validation and data fetching.

## User Scenarios & Testing _(mandatory)_

### User Story 1 - Enter Wallet Address with Visual Confirmation (Priority: P1)

A user creating an invoice needs to enter their own wallet address or their client's wallet address. They need immediate visual feedback that the address is valid and a way to visually distinguish between different addresses.

**Why this priority**: Address entry is the most critical input for crypto invoicing - incorrect addresses mean lost funds with no recovery.

**Independent Test**: Can be fully tested by entering various addresses and observing validation feedback. Delivers core value of secure address entry.

**Acceptance Scenarios**:

1. **Given** an empty address input, **When** user enters a valid Ethereum address (0x..., 42 characters), **Then** the input shows a unique visual identifier (blockie) for that address
2. **Given** an address input, **When** user enters an invalid address format, **Then** the input displays an error state with clear error message
3. **Given** an address input with partial text, **When** user is still typing, **Then** no validation error is shown (validation on blur/complete)
4. **Given** a valid address is entered, **When** user views the blockie, **Then** the color pattern is deterministic (same address = same colors)

---

### User Story 2 - Select Blockchain Network (Priority: P1)

A user needs to select which blockchain network the invoice will be paid on. The selection must integrate with their connected wallet and show network-specific branding.

**Why this priority**: Network selection determines which tokens are available and affects transaction costs. Critical for accurate invoice creation.

**Independent Test**: Can be tested by opening the dropdown and selecting different networks. Delivers value of multi-chain support.

**Acceptance Scenarios**:

1. **Given** the network selector, **When** user clicks to open, **Then** they see all supported networks with distinctive icons and colors
2. **Given** an open network dropdown, **When** user selects a network, **Then** the selection is confirmed and the dropdown closes
3. **Given** a selected network, **When** displayed in closed state, **Then** it shows the network icon, name, and distinctive color
4. **Given** a wallet is connected, **When** user changes network selection, **Then** the wallet is prompted to switch networks

---

### User Story 3 - Select Payment Token (Priority: P1)

A user needs to select which cryptocurrency token they want to receive payment in. The selection depends on the chosen network and shows available token options.

**Why this priority**: Token selection is essential for invoice creation and must show correct options per network.

**Independent Test**: Can be tested by selecting tokens from the list for different networks. Delivers value of multi-token support.

**Acceptance Scenarios**:

1. **Given** a selected network, **When** user opens token selector, **Then** they see tokens available on that specific network
2. **Given** token options, **When** displayed, **Then** each shows symbol, visual indicator, and is clearly distinguishable
3. **Given** user selects a token, **When** selection confirmed, **Then** the token symbol, address, and decimals are captured
4. **Given** different networks selected, **When** token list loads, **Then** token addresses are network-appropriate (different USDC addresses per chain)

---

### User Story 4 - Enter Custom Token Address (Priority: P2)

A user may need to invoice in a token not in the common list. They can enter a custom token contract address.

**Why this priority**: Supports edge cases for less common tokens. Not required for MVP flows using standard tokens.

**Independent Test**: Can be tested by entering a custom token address and verifying metadata loads.

**Acceptance Scenarios**:

1. **Given** token selector, **When** user chooses "Custom Token" option, **Then** they can enter a contract address
2. **Given** custom address entered, **When** address is valid ERC-20, **Then** system fetches and displays token symbol and decimals
3. **Given** invalid custom address, **When** fetch fails, **Then** user can manually enter symbol and decimals
4. **Given** custom token added, **When** user proceeds, **Then** the custom token is used for invoice

---

### User Story 5 - Manage Invoice Line Items (Priority: P1)

A user needs to add, edit, and remove line items on their invoice. Each line item has a description, quantity, and rate.

**Why this priority**: Line items are the core content of any invoice. Essential for basic invoice functionality.

**Independent Test**: Can be tested by adding items, editing values, and removing items. Core invoice creation value.

**Acceptance Scenarios**:

1. **Given** a new invoice, **When** user adds a line item, **Then** a row appears with description, quantity, and rate fields
2. **Given** a line item, **When** user edits quantity or rate, **Then** the line total updates automatically
3. **Given** a line item, **When** user clicks remove, **Then** the item is removed with smooth animation
4. **Given** multiple line items, **When** displayed, **Then** each can be edited independently
5. **Given** a line item row, **When** user edits description, **Then** text is saved (no character limit, but practical length)

---

### Edge Cases

- What happens when an address is copy-pasted with extra whitespace? (Trim automatically)
- How does network selector behave when wallet is not connected? (Shows networks, but no wallet prompt on change)
- What happens when token metadata fetch fails for custom token? (Allow manual entry fallback)
- How does the system handle very long line item descriptions? (Text truncation in preview, full text in edit)
- What if user enters an ENS name instead of address? (Future scope - not in MVP)

## Requirements _(mandatory)_

### Functional Requirements

**AddressInput Component**:

- **FR-001**: Component MUST accept and display Ethereum-format addresses (0x + 40 hex characters)
- **FR-002**: Component MUST display a deterministic visual identifier (blockie-style) based on address value
- **FR-003**: Component MUST validate addresses and show error state for invalid format
- **FR-004**: Component MUST support label, error message, and standard input attributes
- **FR-005**: Component MUST use existing platform validation logic for address checking

**NetworkSelect Component**:

- **FR-006**: Component MUST display all supported networks with distinctive icons and brand colors
- **FR-007**: Component MUST show currently selected network in closed state
- **FR-008**: Component MUST emit change events when user selects different network
- **FR-009**: Component MUST integrate with wallet connection for network switching requests
- **FR-010**: Component MUST support 4 mainnet networks: Ethereum, Arbitrum, Optimism, Polygon

**TokenSelect Component**:

- **FR-011**: Component MUST display tokens available on the currently selected network
- **FR-012**: Component MUST show token symbol and visual indicator for each option
- **FR-013**: Component MUST provide token address and decimals when selection is made
- **FR-014**: Component MUST support custom token entry via contract address
- **FR-015**: Component MUST fetch token metadata (symbol, decimals) for custom addresses when possible

**InvoiceItemRow Component**:

- **FR-016**: Component MUST display description, quantity, and rate input fields
- **FR-017**: Component MUST emit update events when any field changes
- **FR-018**: Component MUST provide remove action for deleting the line item
- **FR-019**: Component MUST display with entrance/exit animations
- **FR-020**: Component MUST receive current currency symbol for display context

### Key Entities

- **WalletAddress**: 42-character hex string (0x prefix + 40 hex), uniquely identifies blockchain account
- **Network**: Supported blockchain (Ethereum, Arbitrum, Optimism, Polygon), determines available tokens
- **Token**: Cryptocurrency on specific network, identified by symbol, contract address, and decimals
- **InvoiceItem**: Line item with description (string), quantity (number), and rate (number)

## Success Criteria _(mandatory)_

### Measurable Outcomes

- **SC-001**: Users can enter a wallet address and see visual confirmation within 100ms of typing
- **SC-002**: Address validation provides feedback before form submission (inline validation)
- **SC-003**: Network selection completes in a single click (dropdown open → select → done)
- **SC-004**: Token list displays within 200ms of opening selector
- **SC-005**: Line item operations (add/edit/remove) feel instant with smooth animations
- **SC-006**: All form components pass accessibility requirements (keyboard navigation, screen reader labels)
- **SC-007**: Test coverage reaches 80%+ for all new components (Constitutional Principle XVI)

## Assumptions

1. **Blockie visualization**: Will use deterministic color generation (not actual ethereum-blockies library) for lighter bundle
2. **Network list**: Fixed to 4 mainnet networks for MVP (no testnets in production UI)
3. **Token lists**: Curated list of common tokens per network (USDC, USDT, DAI, native token, network-specific tokens)
4. **Custom token validation**: Best-effort fetch of ERC-20 metadata, manual fallback always available
5. **No ENS resolution**: Address input accepts raw addresses only (ENS is future scope)
6. **Wagmi integration**: NetworkSelect uses existing Wagmi hooks (useChainId, useSwitchChain) from P0.5

## Design References

| Component      | Source File                                                 | Target Location                              |
| -------------- | ----------------------------------------------------------- | -------------------------------------------- |
| AddressInput   | `assets/aistudio/v3/shared/ui/AddressInput.tsx`             | `src/shared/ui/address-input.tsx`            |
| NetworkSelect  | `assets/aistudio/v3/shared/ui/NetworkSelect.tsx`            | `src/features/wallet/ui/NetworkSelect.tsx`   |
| TokenSelect    | `assets/aistudio/v3/shared/ui/TokenSelect.tsx`              | `src/features/invoice/ui/TokenSelect.tsx`    |
| InvoiceItemRow | `assets/aistudio/v3/features/invoice/ui/InvoiceItemRow.tsx` | `src/features/invoice/ui/InvoiceItemRow.tsx` |

**Architectural Note**:

- AddressInput is a generic shared component (no Web3 logic beyond validation)
- NetworkSelect belongs to wallet feature (uses Wagmi hooks)
- TokenSelect belongs to invoice feature (invoice-specific token lists)
- InvoiceItemRow belongs to invoice feature (invoice domain entity)

## Out of Scope

- ENS name resolution
- Token balance display (separate feature)
- Token price/USD conversion
- Network testnets in production UI
- Multi-signature wallet detection
- Address book / saved addresses
