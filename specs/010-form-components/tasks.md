# Tasks: Form Components (Invoice Editor)

**Input**: Design documents from `/specs/010-form-components/`
**Prerequisites**: plan.md âœ…, spec.md âœ…, research.md âœ…, data-model.md âœ…
**Workflow**: Part of mandatory SpecKit workflow (Constitutional Principle XV). Generated by `/speckit.tasks`.

**Tests**: Per Constitutional Principle XVI (TDD), tests are MANDATORY and MUST be written BEFORE implementation.

- Task format: `T###-test` (write failing test) â†’ `T###-impl` (make test pass)
- Coverage target: 80%+ for merge to main
- Snapshot tests required for component rendering

**Organization**: Tasks are grouped by component/user story to enable independent implementation and testing.

## Format: `[ID] [P?] [Story] Description`

- **[P]**: Can run in parallel (different files, no dependencies)
- **[Story]**: Which user story this task belongs to (e.g., US1, US2, US3)
- Include exact file paths in descriptions

---

## Phase 1: Setup (Shared Infrastructure)

**Purpose**: Project initialization and token registry

- [ ] T001 Create token registry with network token lists in src/features/invoice/model/tokens.ts
- [ ] T002 [P] Create network configuration with icons and colors in src/features/invoice/model/tokens.ts
- [ ] T003 [P] Export TokenInfo interface and NETWORK_TOKENS constant in src/features/invoice/index.ts

---

## Phase 2: Foundational (Shared Utilities)

**Purpose**: Core utilities that MUST be complete before component implementation

**âš ï¸ CRITICAL**: No component work can begin until this phase is complete

- [ ] T004 Verify ETH_ADDRESS_REGEX exists in entities/invoice/lib/validation.ts
- [ ] T005 [P] Create blockie hash generator utility function in src/shared/lib/blockie.ts
- [ ] T006 [P] Export blockie utility in src/shared/lib/utils.ts

**Checkpoint**: Foundation ready - component implementation can now begin in parallel

---

## Phase 3: User Story 1 - Enter Wallet Address with Visual Confirmation (Priority: P1) ðŸŽ¯ MVP

**Goal**: Enable secure wallet address entry with visual identifier (blockie) for confirmation

**Independent Test**: Enter valid/invalid addresses, verify blockie generation and validation feedback

### Tests for User Story 1 (TDD - write FIRST, ensure they FAIL) ðŸ”´

> **TDD CYCLE**: Red (write failing test) â†’ Green (minimal implementation) â†’ Refactor

- [ ] T010-test [P] [US1] Unit test for address validation in src/shared/ui/**tests**/address-input.test.tsx
- [ ] T011-test [P] [US1] Unit test for blockie generation in src/shared/lib/**tests**/blockie.test.ts
- [ ] T012-test [P] [US1] Component test for AddressInput rendering in src/shared/ui/**tests**/address-input.test.tsx
- [ ] T013-test [P] [US1] Snapshot test for AddressInput states in src/shared/ui/**tests**/address-input.test.tsx

### Implementation for User Story 1 (TDD - make tests PASS) ðŸŸ¢

- [ ] T010-impl [P] [US1] Implement blockie hash and color generation (make T011-test pass) in src/shared/lib/blockie.ts
- [ ] T011-impl [US1] Implement AddressInput component with validation (make T010-test, T012-test pass) in src/shared/ui/address-input.tsx
- [ ] T012-impl [US1] Add blockie visualization to AddressInput (make T013-test pass) in src/shared/ui/address-input.tsx
- [ ] T013 [US1] Export AddressInput from src/shared/ui/index.ts
- [ ] T014 [US1] Refactor and cleanup (all tests must stay green)

**Checkpoint**: User Story 1 complete. Verify: all tests passing, coverage â‰¥80%

---

## Phase 4: User Story 2 - Select Blockchain Network (Priority: P1)

**Goal**: Enable network selection with Wagmi integration for wallet switching

**Independent Test**: Open network dropdown, select different networks, verify wallet switching prompt

### Tests for User Story 2 (TDD - write FIRST) ðŸ”´

- [ ] T020-test [P] [US2] Unit test for network list rendering in src/features/wallet-connect/ui/**tests**/NetworkSelect.test.tsx
- [ ] T021-test [P] [US2] Unit test for network selection logic in src/features/wallet-connect/ui/**tests**/NetworkSelect.test.tsx
- [ ] T022-test [P] [US2] Integration test for Wagmi useSwitchChain hook in src/features/wallet-connect/ui/**tests**/NetworkSelect.test.tsx
- [ ] T023-test [P] [US2] Snapshot test for NetworkSelect states in src/features/wallet-connect/ui/**tests**/NetworkSelect.test.tsx

### Implementation for User Story 2 (TDD - make tests PASS) ðŸŸ¢

- [ ] T020-impl [P] [US2] Implement NetworkSelect component base structure (make T020-test pass) in src/features/wallet-connect/ui/NetworkSelect.tsx
- [ ] T021-impl [US2] Integrate Wagmi hooks for network switching (make T021-test, T022-test pass) in src/features/wallet-connect/ui/NetworkSelect.tsx
- [ ] T022-impl [US2] Add Radix Select with Framer Motion animations (make T023-test pass) in src/features/wallet-connect/ui/NetworkSelect.tsx
- [ ] T023 [US2] Export NetworkSelect from src/features/wallet-connect/index.ts
- [ ] T024 [US2] Refactor and cleanup (all tests must stay green)

**Checkpoint**: User Stories 1 AND 2 complete. Coverage still â‰¥80%

---

## Phase 5: User Story 3 - Select Payment Token (Priority: P1)

**Goal**: Enable token selection from network-specific token lists

**Independent Test**: Select network, verify correct token list appears, select tokens

### Tests for User Story 3 (TDD - write FIRST) ðŸ”´

- [ ] T030-test [P] [US3] Unit test for token filtering by chainId in src/features/invoice/ui/**tests**/TokenSelect.test.tsx
- [ ] T031-test [P] [US3] Unit test for token selection logic in src/features/invoice/ui/**tests**/TokenSelect.test.tsx
- [ ] T032-test [P] [US3] Unit test for token list rendering in src/features/invoice/ui/**tests**/TokenSelect.test.tsx
- [ ] T033-test [P] [US3] Snapshot test for TokenSelect states in src/features/invoice/ui/**tests**/TokenSelect.test.tsx

### Implementation for User Story 3 (TDD - make tests PASS) ðŸŸ¢

- [ ] T030-impl [P] [US3] Implement token filtering by network (make T030-test pass) in src/features/invoice/ui/TokenSelect.tsx
- [ ] T031-impl [US3] Implement TokenSelect component with list rendering (make T031-test, T032-test pass) in src/features/invoice/ui/TokenSelect.tsx
- [ ] T032-impl [US3] Add Radix Select styling and layout (make T033-test pass) in src/features/invoice/ui/TokenSelect.tsx
- [ ] T033 [US3] Export TokenSelect from src/features/invoice/index.ts
- [ ] T034 [US3] Refactor and cleanup (all tests must stay green)

**Checkpoint**: User Stories 1, 2, AND 3 complete. Coverage still â‰¥80%

---

## Phase 6: User Story 4 - Enter Custom Token Address (Priority: P2)

**Goal**: Enable custom token entry with automatic metadata fetching

**Independent Test**: Click "Custom Token", enter token address, verify metadata fetch or manual fallback

### Tests for User Story 4 (TDD - write FIRST) ðŸ”´

- [ ] T040-test [P] [US4] Unit test for custom token address validation in src/features/invoice/ui/**tests**/TokenSelect.test.tsx
- [ ] T041-test [P] [US4] Integration test for token metadata fetch (mocked) in src/features/invoice/ui/**tests**/TokenSelect.test.tsx
- [ ] T042-test [P] [US4] Unit test for manual token entry fallback in src/features/invoice/ui/**tests**/TokenSelect.test.tsx
- [ ] T043-test [P] [US4] Snapshot test for custom token entry UI in src/features/invoice/ui/**tests**/TokenSelect.test.tsx

### Implementation for User Story 4 (TDD - make tests PASS) ðŸŸ¢

- [ ] T040-impl [P] [US4] Add custom token entry mode to TokenSelect (make T040-test pass) in src/features/invoice/ui/TokenSelect.tsx
- [ ] T041-impl [US4] Implement token metadata fetch with readContract (make T041-test pass) in src/features/invoice/ui/TokenSelect.tsx
- [ ] T042-impl [US4] Add manual entry fallback UI (make T042-test, T043-test pass) in src/features/invoice/ui/TokenSelect.tsx
- [ ] T043 [US4] Refactor and cleanup (all tests must stay green)

**Checkpoint**: User Stories 1-4 complete. Coverage still â‰¥80%

---

## Phase 7: User Story 5 - Manage Invoice Line Items (Priority: P1)

**Goal**: Enable add/edit/remove operations for invoice line items with animations

**Independent Test**: Add line item, edit fields, verify total calculation, remove with animation

### Tests for User Story 5 (TDD - write FIRST) ðŸ”´

- [ ] T050-test [P] [US5] Unit test for line item field updates in src/features/invoice/ui/**tests**/InvoiceItemRow.test.tsx
- [ ] T051-test [P] [US5] Unit test for remove action in src/features/invoice/ui/**tests**/InvoiceItemRow.test.tsx
- [ ] T052-test [P] [US5] Unit test for line total calculation in src/features/invoice/ui/**tests**/InvoiceItemRow.test.tsx
- [ ] T053-test [P] [US5] Snapshot test for InvoiceItemRow states in src/features/invoice/ui/**tests**/InvoiceItemRow.test.tsx

### Implementation for User Story 5 (TDD - make tests PASS) ðŸŸ¢

- [ ] T050-impl [P] [US5] Implement InvoiceItemRow component structure (make T050-test pass) in src/features/invoice/ui/InvoiceItemRow.tsx
- [ ] T051-impl [US5] Add field change handlers and validations (make T051-test, T052-test pass) in src/features/invoice/ui/InvoiceItemRow.tsx
- [ ] T052-impl [US5] Add Framer Motion animations for enter/exit (make T053-test pass) in src/features/invoice/ui/InvoiceItemRow.tsx
- [ ] T053 [US5] Export InvoiceItemRow from src/features/invoice/index.ts
- [ ] T054 [US5] Refactor and cleanup (all tests must stay green)

**Checkpoint**: All user stories complete. Final coverage check â‰¥80%

---

## Phase 8: Polish & Cross-Cutting Concerns

**Purpose**: Improvements that affect multiple components

- [ ] T060 [P] Accessibility audit for all form components (keyboard navigation, ARIA labels)
- [ ] T061 [P] Performance optimization for blockie generation (<100ms target)
- [ ] T062 [P] Performance optimization for token list rendering (<200ms target)
- [ ] T063 Code cleanup and refactoring across all components
- [ ] T064 [P] Update component documentation with usage examples
- [ ] T065 Run quickstart.md validation scenarios

---

## Phase FINAL: Memory Updates (MANDATORY - Constitutional Principle XIV)

**Purpose**: Update Serena memories to keep project knowledge current

**âš ï¸ CRITICAL**: This phase is NON-OPTIONAL. Feature completion without memory updates is a Constitutional violation.

- [ ] TMEM-1 Update `development-status` memory with completed feature
- [ ] TMEM-2 Review `tech-stack-locked` memory for new component patterns
- [ ] TMEM-3 [P] Update `architecture-summary` with FSD component organization
- [ ] TMEM-4 [P] Write `form-components-pattern` memory for reusable patterns
- [ ] TMEM-5 Verify all consulted memories have current "Last Updated" dates
- [ ] TMEM-6 Commit memory changes: git add .serena/memories/ && git commit -m "docs(memory): update after 010-form-components"

**Checkpoint**: All relevant memories updated. Feature ready for merge.

---

## Dependencies & Execution Order

### Phase Dependencies

- **Setup (Phase 1)**: No dependencies - can start immediately
- **Foundational (Phase 2)**: Depends on Setup completion - BLOCKS all component stories
- **User Stories (Phase 3-7)**: All depend on Foundational phase completion
  - US1 (Address Input): Can start after Foundational
  - US2 (Network Select): Can start after Foundational (independent of US1)
  - US3 (Token Select): Can start after Foundational (independent of US1, US2)
  - US4 (Custom Token): Depends on US3 completion (extends TokenSelect)
  - US5 (Invoice Items): Can start after Foundational (independent of US1-4)
- **Polish (Phase 8)**: Depends on all desired user stories being complete
- **Memory Updates (Phase FINAL)**: Depends on feature completion

### User Story Dependencies

- **User Story 1 (Address Input)**: Independent - can start after Phase 2
- **User Story 2 (Network Select)**: Independent - can start after Phase 2
- **User Story 3 (Token Select)**: Independent - can start after Phase 2
- **User Story 4 (Custom Token)**: Depends on US3 (extends TokenSelect component)
- **User Story 5 (Invoice Items)**: Independent - can start after Phase 2

### Within Each User Story (TDD Cycle)

- Tests MUST be written and FAIL before implementation (Red phase)
- Implementation MUST be minimal to pass tests (Green phase)
- Refactor only when tests are green (Refactor phase)
- All parallel tasks marked [P] can run simultaneously
- Coverage check at each checkpoint

### Parallel Opportunities

- **Phase 1**: All tasks marked [P] can run in parallel
- **Phase 2**: All tasks marked [P] can run in parallel
- **Phase 3-7**: US1, US2, US3, and US5 can ALL run in parallel (independent components)
  - US4 must wait for US3 completion
- **Phase 8**: All tasks marked [P] can run in parallel
- **Phase FINAL**: All memory update tasks marked [P] can run in parallel

---

## Parallel Example: User Story 1 (TDD)

```bash
# TDD RED PHASE: Launch all tests for US1 together (write first, must fail):
Task: "T010-test: Unit test for address validation in __tests__/address-input.test.tsx"
Task: "T011-test: Unit test for blockie generation in __tests__/blockie.test.ts"
Task: "T012-test: Component test for AddressInput rendering in __tests__/address-input.test.tsx"
Task: "T013-test: Snapshot test for AddressInput states in __tests__/address-input.test.tsx"

# TDD GREEN PHASE: Launch implementations in parallel:
Task: "T010-impl: Implement blockie hash and color generation"
Task: "T011-impl: Implement AddressInput component with validation"

# TDD REFACTOR PHASE: Cleanup while keeping tests green
Task: "T014: Refactor and cleanup (all tests must stay green)"
```

---

## Parallel Example: Multiple User Stories

```bash
# After Phase 2 completes, these can ALL run in parallel:
Developer A: User Story 1 (AddressInput) - T010-test through T014
Developer B: User Story 2 (NetworkSelect) - T020-test through T024
Developer C: User Story 3 (TokenSelect) - T030-test through T034
Developer D: User Story 5 (InvoiceItemRow) - T050-test through T054

# Then sequentially:
Developer C continues: User Story 4 (Custom Token) - T040-test through T043
```

---

## Implementation Strategy

### MVP First (Critical Path)

1. Complete Phase 1: Setup (token registry)
2. Complete Phase 2: Foundational (blockie utility, validation)
3. Complete Phase 3: User Story 1 (AddressInput) - STOP and VALIDATE
4. Complete Phase 4: User Story 2 (NetworkSelect) - STOP and VALIDATE
5. Complete Phase 5: User Story 3 (TokenSelect) - STOP and VALIDATE
6. Complete Phase 7: User Story 5 (InvoiceItemRow) - STOP and VALIDATE
7. **MVP COMPLETE**: All P1 components ready for invoice editor integration

### Incremental Delivery

1. Setup + Foundational â†’ Foundation ready
2. Add AddressInput (US1) â†’ Test independently â†’ Available for use
3. Add NetworkSelect (US2) â†’ Test independently â†’ Available for use
4. Add TokenSelect (US3) â†’ Test independently â†’ Available for use
5. Add InvoiceItemRow (US5) â†’ Test independently â†’ Ready for invoice editor
6. Optionally add Custom Token (US4) â†’ Enhancement to TokenSelect

### Parallel Team Strategy

With 4 developers after Phase 2:

1. Team completes Setup + Foundational together (T001-T006)
2. Once Foundational is done, split into parallel workstreams:
   - Developer A: US1 (AddressInput) - T010-test through T014
   - Developer B: US2 (NetworkSelect) - T020-test through T024
   - Developer C: US3 (TokenSelect) - T030-test through T034
   - Developer D: US5 (InvoiceItemRow) - T050-test through T054
3. Developer C adds US4 (Custom Token) - T040-test through T043
4. Team converges for Phase 8 (Polish) and Phase FINAL (Memory Updates)

---

## Test Coverage Summary

| Component            | Unit Tests | Integration | Snapshot | Total  |
| -------------------- | ---------- | ----------- | -------- | ------ |
| AddressInput         | 3          | 0           | 1        | 4      |
| blockie utility      | 1          | 0           | 0        | 1      |
| NetworkSelect        | 2          | 1           | 1        | 4      |
| TokenSelect (base)   | 3          | 0           | 1        | 4      |
| TokenSelect (custom) | 2          | 1           | 1        | 4      |
| InvoiceItemRow       | 3          | 0           | 1        | 4      |
| **Total**            | **14**     | **2**       | **5**    | **21** |

**Target**: 21+ tests, 80%+ coverage for all components

---

## Notes

- [P] tasks = different files, no dependencies, can run in parallel
- [Story] label maps task to specific user story for traceability
- **TDD**: T###-test tasks MUST be written first and FAIL before T###-impl tasks
- **TDD**: Commit `[WIP]` allowed in feature branches; merge requires all tests green
- **Coverage**: Check coverage at each checkpoint, must be â‰¥80% before merge
- **Mocking**: Wagmi hooks and readContract must be mocked in tests
- **Isolation**: Each component should be testable without others (except US4 extends US3)
- Commit after each task or logical group
- Stop at any checkpoint to validate component independently

### Deviation Tracking (Principle IX)

When marking tasks complete, **MUST** record any implementation deviations:

**Format**: `- [x] T001 [Description] | Deviation: [None | <deviation description>]`

**Record if**:

- Actual implementation differs from plan.md, spec.md, or data-model.md
- Different approach was used due to technical constraints
- Better solution discovered during implementation
- Requirements evolved during development

**Include**:

- What was planned (with artifact reference)
- What was actually done
- Why the change was made
- Impact (breaking changes, performance, security)

**Examples**:

- `- [x] T011-impl [US1] Implement AddressInput component | Deviation: None`
- `- [x] T021-impl [US2] Integrate Wagmi hooks | Deviation: Used useAccount for connection status check (not in plan.md). Reason: Needed to disable network switching when wallet disconnected. Impact: None, enhances UX per FR-009.`

**After feature completion**: Review all deviations to update spec.md, plan.md, or data-model.md accordingly.

### ROADMAP Updates (Principle IX)

Upon completing this feature, **MUST** update `ROADMAP_P0.md`:

**Required Information**:

- Feature completion status: `ðŸŸ¢ **Completed**: YYYY-MM-DD`
- **Feature Folder**: `specs/010-form-components/`
- **Implemented**: Brief summary (AddressInput, NetworkSelect, TokenSelect, InvoiceItemRow)
- **Deviations**: Key deviations from original plan (if any)
- **Notes**: Technical decisions or constraints encountered

**Update Location**: Find P0.8.1 in `ROADMAP_P0.md` and update its status block.
