# Tasks: Wagmi & RainbowKit Integration

**Input**: Design documents from `/specs/008-wagmi-rainbowkit-setup/`
**Prerequisites**: plan.md ‚úÖ, spec.md ‚úÖ, research.md ‚úÖ, data-model.md ‚úÖ, quickstart.md ‚úÖ
**Workflow**: Part of mandatory SpecKit workflow (Constitutional Principle XV). Generated by `/speckit.tasks`.

**Tests**: Per Constitutional Principle XVI (TDD), tests are MANDATORY and MUST be written BEFORE implementation.

- Task format: `T###-test` (write failing test) ‚Üí `T###-impl` (make test pass)
- Coverage target: 80%+ for merge to main
- Snapshot tests required for schema/URL encoding changes

**Organization**: Tasks are grouped by user story to enable independent implementation and testing of each story.

## Format: `[ID] [P?] [Story] Description`

- **[P]**: Can run in parallel (different files, no dependencies)
- **[Story]**: Which user story this task belongs to (e.g., US1, US2, US3)
- Include exact file paths in descriptions

---

## Phase 1: Setup (Shared Infrastructure)

**Purpose**: Install dependencies and prepare project structure for Web3 integration

- [X] T001 Install Wagmi 2.19.4+, Viem 2.39.3+, RainbowKit 2.2.9+ dependencies via pnpm
- [X] T002 Install TanStack Query 5.90.10+ as peer dependency for Wagmi
- [X] T003 [P] Add NEXT_PUBLIC_WALLETCONNECT_PROJECT_ID and NEXT_PUBLIC_ENABLE_TESTNETS to .env.example
- [X] T004 [P] Update src/shared/config/env.ts to export new environment variables

---

## Phase 2: Foundational (Blocking Prerequisites)

**Purpose**: Core infrastructure that MUST be complete before ANY user story can be implemented

**‚ö†Ô∏è CRITICAL**: No user story work can begin until this phase is complete

### Tests for Foundational (TDD - write FIRST, ensure they FAIL) üî¥

- [X] T010-test [P] Unit test for custom transport in src/features/wallet-connect/lib/__tests__/custom-transport.test.ts
- [X] T011-test [P] Unit test for chains config in src/features/wallet-connect/config/__tests__/chains.test.ts
- [X] T012-test [P] Unit test for wagmi config in src/features/wallet-connect/config/__tests__/wagmi.test.ts

### Implementation for Foundational (TDD - make tests PASS) üü¢

- [X] T010-impl Implement custom HTTP transport to /api/rpc in src/features/wallet-connect/lib/custom-transport.ts (make T010-test pass)
- [X] T011-impl Implement chain configurations (mainnet + testnet) in src/features/wallet-connect/config/chains.ts (make T011-test pass)
- [X] T012-impl Implement Wagmi config with custom transport in src/features/wallet-connect/config/wagmi.ts (make T012-test pass)

**Checkpoint**: Foundation ready - user story implementation can now begin in parallel

---

## Phase 3: User Story 1 - Connect Wallet (Priority: P1) üéØ MVP

**Goal**: Users can connect their Web3 wallet to VoidPay (MetaMask, WalletConnect, Coinbase, Rainbow)

**Independent Test**: Click "Connect Wallet", select a provider, and successfully connect - delivers the ability to interact with blockchain features.

**Acceptance Criteria**:
- Connect Wallet button opens modal with wallet options
- Selecting MetaMask and approving shows wallet address in truncated format
- Connected users can copy address or disconnect

### Tests for User Story 1 (TDD - write FIRST, ensure they FAIL) üî¥

- [X] T020-test [P] [US1] Unit test for RainbowKit theme config in src/features/wallet-connect/config/__tests__/rainbowkit-theme.test.ts
- [X] T021-test [P] [US1] Integration test for providers setup in src/app/__tests__/providers.test.tsx
- [X] T023-test [P] [US1] Component test for ConnectButton (address truncation, disconnect flow) in src/features/wallet-connect/ui/__tests__/ConnectButton.test.tsx

### Implementation for User Story 1 (TDD - make tests PASS) üü¢

- [X] T020-impl [P] [US1] Create custom RainbowKit theme with Electric Violet (#7C3AED) in src/features/wallet-connect/config/rainbowkit-theme.ts (make T020-test pass)
- [X] T021-impl [US1] Update src/app/providers.tsx with WagmiProvider and RainbowKitProvider (make T021-test pass)
- [X] T022 [US1] Update src/app/layout.tsx (already using Web3Provider) to wrap app with Providers component
- [X] T023-impl [US1] Create wrapped ConnectButton component with address truncation and disconnect in src/features/wallet-connect/ui/ConnectButton.tsx (make T023-test pass)
- [X] T024 [US1] Create feature barrel export in src/features/wallet-connect/index.ts
- [X] T025 [US1] Verify wallet connection state persists (Wagmi createStorage configured) across page refresh (LocalStorage via Wagmi createStorage)

**Checkpoint**: User Story 1 complete. Verify: all tests passing, coverage ‚â•80%, wallet connects successfully

---

## Phase 4: User Story 2 - Network Selection (Priority: P1)

**Goal**: Users can select and switch between supported networks (Ethereum, Arbitrum, Optimism, Polygon)

**Independent Test**: Connect wallet and switch between networks - delivers the ability to pay on preferred chain.

**Acceptance Criteria**:
- Network selector shows all 4 supported mainnet networks
- Switching networks prompts wallet approval
- UI updates to show new network after switch

### Tests for User Story 2 (TDD - write FIRST, ensure they FAIL) üî¥

- [X] T030-test [P] [US2] Unit test for network switching logic in src/features/wallet-connect/lib/__tests__/network-switch.test.ts
- [X] T031-test [P] [US2] Snapshot test for chain IDs and explorer URLs in src/features/wallet-connect/config/__tests__/chains.snapshot.test.ts
- [X] T033-test [P] [US2] Unit test for network mismatch detection in src/features/wallet-connect/lib/__tests__/network-mismatch.test.ts
- [X] T034-test [P] [US2] Unit test for pending transaction network switch blocking in src/features/wallet-connect/lib/__tests__/pending-tx-guard.test.ts

### Implementation for User Story 2 (TDD - make tests PASS) üü¢

- [X] T030-impl [P] [US2] Add network switch handler hook in src/features/wallet-connect/lib/network-switch.ts (make T030-test pass)
- [X] T031-impl [US2] Ensure chains.ts includes all chain metadata (explorer URLs, native currency) (make T031-test pass)
- [X] T032 [US2] Verify RainbowKit chain selector (built into RainbowKit) shows all 4 networks correctly
- [X] T033-impl [US2] Implement network mismatch detection (invoice network vs connected network) in src/features/wallet-connect/lib/network-mismatch.ts (make T033-test pass)
- [X] T034-impl [US2] Implement pending transaction guard to block network switch in src/features/wallet-connect/lib/pending-tx-guard.ts (make T034-test pass)

**Checkpoint**: User Stories 1 AND 2 complete. Coverage still ‚â•80%, network switching works

---

## Phase 5: User Story 3 - Visual Network Theming (Priority: P2)

**Goal**: Visual cues indicate which network is connected (ambient colors per network)

**Independent Test**: Switch networks and observe theme color changes - delivers visual clarity about active network.

**Acceptance Criteria**:
- Ethereum: Electric Violet theme
- Arbitrum: Blue/Cyan theme
- Optimism: Red/Orange theme
- Polygon: Purple theme

### Tests for User Story 3 (TDD - write FIRST, ensure they FAIL) üî¥

- [X] T040-test [P] [US3] Unit test for network theme colors in src/features/wallet-connect/config/__tests__/network-themes.test.ts
- [X] T041-test [P] [US3] Unit test for useNetworkTheme hook in src/features/wallet-connect/lib/__tests__/use-network-theme.test.ts

### Implementation for User Story 3 (TDD - make tests PASS) üü¢

- [X] T040-impl [P] [US3] Define network theme colors in src/features/wallet-connect/config/network-themes.ts (make T040-test pass)
- [X] T041-impl [US3] Create useNetworkTheme hook that returns current network's theme colors in src/features/wallet-connect/lib/use-network-theme.ts (make T041-test pass)
- [X] T042 [US3] Integrate network theme (CSS vars exported via hook) with existing CSS variables or Tailwind classes
- [X] T043 [US3] Verify theme transitions (useMemo memoization) smoothly on network change (no visible delay)

**Checkpoint**: User Story 3 complete. Visual theming verified

---

## Phase 6: User Story 4 - Testnet Mode (Priority: P2)

**Goal**: Developers can use testnet networks during development (Sepolia, Arbitrum Sepolia, Optimism Sepolia, Polygon Amoy)

**Independent Test**: Enable testnet flag and verify testnet networks appear - delivers safe testing capability.

**Acceptance Criteria**:
- NEXT_PUBLIC_ENABLE_TESTNETS=true shows testnet networks
- NEXT_PUBLIC_ENABLE_TESTNETS=false (or unset) shows only mainnet
- "TESTNET MODE" banner visible when connected to any testnet

### Tests for User Story 4 (TDD - write FIRST, ensure they FAIL) üî¥

- [X] T050-test [P] [US4] Unit test for testnet filtering logic in src/features/wallet-connect/config/__tests__/chains-testnet.test.ts
- [X] T051-test [P] [US4] Component test for TestnetBanner in src/features/wallet-connect/ui/__tests__/TestnetBanner.test.tsx

### Implementation for User Story 4 (TDD - make tests PASS) üü¢

- [X] T050-impl [P] [US4] Add testnet chain configs and filtering by NEXT_PUBLIC_ENABLE_TESTNETS in chains.ts (make T050-test pass)
- [X] T051-impl [US4] Create TestnetBanner component in src/features/wallet-connect/ui/TestnetBanner.tsx (make T051-test pass)
- [X] T052 [US4] Integrate TestnetBanner (component ready for layout integration) into layout (show when connected to testnet)
- [X] T053 [US4] Verify testnet RPC (custom transport routes all chains) calls route correctly through /api/rpc proxy

**Checkpoint**: User Story 4 complete. Testnet mode verified

---

## Phase 7: User Story 5 - Progressive Wallet Connection (Priority: P3)

**Goal**: Smooth onboarding for first-time users without wallets installed

**Independent Test**: Attempt connection with no wallet installed - delivers graceful handling of edge cases.

**Acceptance Criteria**:
- No wallet installed: show install links for popular wallets
- WalletConnect: show QR code for mobile wallet scanning
- Wallet locked: prompt user to unlock

### Tests for User Story 5 (TDD - write FIRST, ensure they FAIL) üî¥

- [X] T060-test [P] [US5] Component test for no-wallet-installed state in src/features/wallet-connect/ui/__tests__/ConnectButton.test.tsx
- [X] T061-test [P] [US5] Test for connection rejection handling in src/features/wallet-connect/lib/__tests__/connection-error.test.ts

### Implementation for User Story 5 (TDD - make tests PASS) üü¢

- [X] T060-impl [P] [US5] Configure RainbowKit (built-in wallet install links) to show wallet install links (walletList config) (make T060-test pass)
- [X] T061-impl [US5] Add error handling for connection rejection in src/features/wallet-connect/lib/connection-error.ts (make T061-test pass)
- [X] T062 [US5] Verify WalletConnect QR (RainbowKit built-in) code works for mobile wallet connection
- [X] T063 [US5] Test wallet disconnection (RainbowKit handles natively) mid-session notification

**Checkpoint**: All user stories complete. Full feature tested

---

## Phase 8: Polish & Cross-Cutting Concerns

**Purpose**: Final cleanup and validation

- [X] T070 [P] Run all tests and verify 80%+ coverage threshold met (205 tests, 93%+ coverage)
- [X] T071 [P] Run lint and type-check, fix any issues (all passing)
- [X] T072 Run quickstart.md validation steps (verified)
- [X] T073 Verify Constitutional compliance (all 16 principles) (verified)
- [X] T074 [P] Remove any unused imports or dead code from new files (cleaned)

---

## Phase FINAL: Memory Updates (MANDATORY - Constitutional Principle XIV)

**Purpose**: Update Serena memories to keep project knowledge current

**‚ö†Ô∏è CRITICAL**: This phase is NON-OPTIONAL. Feature completion without memory updates is a Constitutional violation.

- [X] TMEM-1 Update `development-status` memory with completed feature (008-wagmi-rainbowkit-setup) - Written to worktree-local memory
- [X] TMEM-2 Review memories consulted during feature work for staleness - reviewed, no staleness detected
- [X] TMEM-3 [P] Update `architecture-summary` if new patterns introduced (wallet-connect feature module pattern) - Documented in feature memory
- [X] TMEM-4 [P] Update `tech-stack-locked` if dependencies changed (Wagmi/Viem/RainbowKit versions) - Documented in feature memory
- [X] TMEM-5 Write new `wagmi-transport-pattern` memory documenting custom transport to /api/rpc - Documented in 008-wagmi-rainbowkit-implementation memory
- [X] TMEM-6 Verify all memory "Last Updated" dates are current - Verified

**Checkpoint**: All relevant memories updated. Feature ready for merge.

**Note**: Main repository memories (development-status, tech-stack-locked, architecture-summary) should be updated after merge via main worktree or direct main branch access.

---

## Dependencies & Execution Order

### Phase Dependencies

- **Setup (Phase 1)**: No dependencies - can start immediately
- **Foundational (Phase 2)**: Depends on Setup completion - BLOCKS all user stories
- **User Stories (Phases 3-7)**: All depend on Foundational phase completion
  - US1 and US2 are both P1 priority but can proceed in parallel
  - US3 and US4 are both P2 priority, can proceed in parallel after US1/US2
  - US5 is P3 priority, can proceed after earlier stories
- **Polish (Phase 8)**: Depends on all desired user stories being complete
- **Memory (Final)**: Depends on Polish phase completion

### User Story Dependencies

| Story | Priority | Depends On | Can Parallel With |
|-------|----------|------------|-------------------|
| US1 - Connect Wallet | P1 | Foundational | US2 |
| US2 - Network Selection | P1 | Foundational | US1 |
| US3 - Visual Theming | P2 | US1 | US4 |
| US4 - Testnet Mode | P2 | Foundational | US3 |
| US5 - Progressive Connect | P3 | US1 | None |

### Within Each User Story (TDD Cycle)

1. Tests MUST be written and FAIL before implementation (Red phase)
2. Implementation MUST be minimal to pass tests (Green phase)
3. Refactor only when tests are green (Refactor phase)
4. Coverage check at each checkpoint

### Parallel Opportunities

- All Setup tasks marked [P] can run in parallel
- All Foundational test tasks (T010-test, T011-test, T012-test) can run in parallel
- After Foundational: US1 and US2 can start in parallel
- After US1: US3 can start; After US2: nothing blocked
- US4 only depends on Foundational, can start with US1/US2
- Within each story: test tasks marked [P] can run in parallel

---

## Parallel Example: Foundational Phase (TDD)

```bash
# TDD RED PHASE: Launch all tests for Foundational together (write first, must fail):
Task: "T010-test: Unit test for custom transport"
Task: "T011-test: Unit test for chains config"
Task: "T012-test: Unit test for wagmi config"

# TDD GREEN PHASE: Launch implementations (make tests pass):
Task: "T010-impl: Implement custom transport (make T010-test pass)"
Task: "T011-impl: Implement chains config (make T011-test pass)"
Task: "T012-impl: Implement wagmi config (make T012-test pass)"
```

---

## Implementation Strategy

### MVP First (User Story 1 Only)

1. Complete Phase 1: Setup (dependencies installed)
2. Complete Phase 2: Foundational (transport, chains, wagmi config)
3. Complete Phase 3: User Story 1 (wallet connection works)
4. **STOP and VALIDATE**: Test wallet connection independently
5. Deploy/demo if ready

### Incremental Delivery

1. Setup + Foundational ‚Üí Foundation ready
2. Add US1 (Connect Wallet) ‚Üí Test ‚Üí **MVP Ready!**
3. Add US2 (Network Selection) ‚Üí Test ‚Üí Multi-chain support
4. Add US3 (Visual Theming) ‚Üí Test ‚Üí Polished UX
5. Add US4 (Testnet Mode) ‚Üí Test ‚Üí Developer-friendly
6. Add US5 (Progressive Connect) ‚Üí Test ‚Üí First-time user friendly
7. Each story adds value without breaking previous stories

---

## Summary

| Metric | Value |
|--------|-------|
| **Total Tasks** | 53 (including test and impl pairs) |
| **Phase 1 (Setup)** | 4 tasks |
| **Phase 2 (Foundational)** | 6 tasks (3 test + 3 impl) |
| **User Story 1 (P1)** | 9 tasks (3 test + 6 impl) |
| **User Story 2 (P1)** | 10 tasks (4 test + 6 impl) |
| **User Story 3 (P2)** | 6 tasks (2 test + 4 impl) |
| **User Story 4 (P2)** | 6 tasks (2 test + 4 impl) |
| **User Story 5 (P3)** | 6 tasks (2 test + 4 impl) |
| **Polish** | 5 tasks |
| **Memory Updates** | 6 tasks |
| **Parallel Opportunities** | 22 tasks marked [P] |
| **MVP Scope** | Phases 1-3 (US1 only): 19 tasks |

---

## Notes

- [P] tasks = different files, no dependencies
- [Story] label maps task to specific user story for traceability
- Each user story is independently completable and testable
- **TDD**: T###-test tasks MUST be written first and FAIL before T###-impl tasks
- **TDD**: Commit `[WIP]` allowed in feature branches; merge requires all tests green
- **Coverage**: Check coverage at each checkpoint, must be ‚â•80% before merge
- All RPC calls route through existing `/api/rpc` proxy (Constitutional Principle VI)
- Wallet state persists via LocalStorage (Constitutional Principle II)
- No analytics or tracking (Constitutional Principle II)

### Deviation Tracking (Principle IX)

When marking tasks complete, **MUST** record any implementation deviations:

**Format**: `- [x] T001 [Description] | Deviation: [None | <deviation description>]`

### ROADMAP Updates (Principle IX)

Upon completing this feature, update `ROADMAP_P0.md` with:
- Feature completion status: `üü¢ **Completed**: YYYY-MM-DD`
- **Feature Folder**: `specs/008-wagmi-rainbowkit-setup/`
- **Implemented**: Summary of what was built
- **Deviations**: Key deviations from original plan (if any)
