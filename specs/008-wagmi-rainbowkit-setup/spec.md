# Feature Specification: Wagmi + Viem + RainbowKit Setup

**Feature Branch**: `008-wagmi-rainbowkit-setup`
**Created**: 2025-11-28
**Status**: Draft
**Input**: User description: "P0.5 - Wagmi + Viem + RainbowKit Setup with Testnet Configuration"

_Note: Generated by `/speckit.specify` command per Constitutional Principle XV (SpecKit Workflow Compliance)_

## User Scenarios & Testing _(mandatory)_

### User Story 1 - Connect Wallet (Priority: P1)

As a crypto user, I want to connect my wallet to VoidPay so that I can make payments on invoices.

**Why this priority**: Wallet connection is the fundamental action required for all Web3 functionality. Without this, no payments can be made.

**Independent Test**: Can be fully tested by clicking "Connect Wallet", selecting a provider, and successfully connecting - delivers the ability to interact with blockchain features.

**Acceptance Scenarios**:

1. **Given** I am on any page with wallet functionality, **When** I click "Connect Wallet", **Then** I see a modal with wallet options (MetaMask, WalletConnect, Coinbase Wallet, Rainbow)
2. **Given** the wallet modal is open, **When** I select MetaMask and approve the connection, **Then** my wallet address is displayed in the header and the modal closes
3. **Given** I am connected, **When** I click on my wallet address, **Then** I see options to copy address or disconnect

---

### User Story 2 - Network Selection (Priority: P1)

As a payer, I want to select or switch between supported networks so that I can pay on the network where I hold funds.

**Why this priority**: Multi-network support is critical for user flexibility and is a core feature of the platform (4 networks: Ethereum, Arbitrum, Optimism, Polygon).

**Independent Test**: Can be tested by connecting wallet and switching between networks - delivers the ability to pay on preferred chain.

**Acceptance Scenarios**:

1. **Given** I am connected on Ethereum Mainnet, **When** I select Arbitrum from the network selector, **Then** I am prompted to switch networks in my wallet
2. **Given** the invoice specifies Polygon, **When** I am connected on a different network, **Then** I see a prompt to switch to Polygon before paying
3. **Given** I approve the network switch in my wallet, **When** the switch completes, **Then** the UI updates to show the new network with its theme color

---

### User Story 3 - Visual Network Theming (Priority: P2)

As a user, I want to see visual cues about which network I'm connected to so that I don't accidentally pay on the wrong chain.

**Why this priority**: Visual feedback reduces errors but is not blocking for core functionality.

**Independent Test**: Can be tested by switching networks and observing theme changes - delivers visual clarity about active network.

**Acceptance Scenarios**:

1. **Given** I am connected to Ethereum, **When** viewing the payment page, **Then** the accent colors and ambient glow use the Ethereum violet theme
2. **Given** I switch to Arbitrum, **When** the switch completes, **Then** the theme transitions to blue/cyan colors
3. **Given** I switch to Optimism, **When** the switch completes, **Then** the theme transitions to red/orange colors
4. **Given** I switch to Polygon, **When** the switch completes, **Then** the theme transitions to purple colors

---

### User Story 4 - Testnet Mode (Priority: P2)

As a developer, I want to use testnet networks during development so that I can test payment flows without real funds.

**Why this priority**: Essential for development and QA but not required for production users.

**Independent Test**: Can be tested by enabling testnet flag and verifying testnet networks appear - delivers safe testing capability.

**Acceptance Scenarios**:

1. **Given** `NEXT_PUBLIC_ENABLE_TESTNETS=true`, **When** I open the network selector, **Then** I see testnet options (Sepolia, Arbitrum Sepolia, Optimism Sepolia, Polygon Amoy)
2. **Given** testnets are enabled, **When** I am connected to any testnet, **Then** I see a prominent "TESTNET MODE" banner indicating non-production environment
3. **Given** `NEXT_PUBLIC_ENABLE_TESTNETS=false` (or unset), **When** I open the network selector, **Then** I only see mainnet networks

---

### User Story 5 - Progressive Wallet Connection (Priority: P3)

As a first-time user, I want a smooth onboarding experience when connecting my wallet so that I'm not overwhelmed by technical complexity.

**Why this priority**: Improves UX but core functionality works without enhanced onboarding.

**Independent Test**: Can be tested by attempting connection with no wallet installed - delivers graceful handling of edge cases.

**Acceptance Scenarios**:

1. **Given** I don't have a wallet installed, **When** I click "Connect Wallet", **Then** I see options to install popular wallets with direct links
2. **Given** I select WalletConnect, **When** the modal opens, **Then** I see a QR code I can scan with my mobile wallet
3. **Given** my wallet is locked, **When** I try to connect, **Then** I see a message prompting me to unlock my wallet

---

### Edge Cases

- What happens when the user rejects the connection request in their wallet? Show "Connection rejected" message and allow retry.
- How does system handle network switching when transaction is pending? Block network switch and show informative message.
- What happens when RPC provider is unavailable? Fallback to secondary provider (Alchemy → Infura) silently.
- How does the system handle mobile wallet deep-linking? Use WalletConnect protocol for mobile compatibility.
- What happens if wallet is disconnected mid-session? Show "Wallet disconnected" notification and reset connection state.

## Requirements _(mandatory)_

### Functional Requirements

- **FR-001**: System MUST integrate Wagmi v2.x (^2.19.4) for React hooks-based Web3 interactions
- **FR-002**: System MUST integrate Viem v2.39.3+ as the underlying Ethereum library
- **FR-003**: System MUST integrate RainbowKit v2.2.9+ for wallet connection UI
- **FR-004**: System MUST support wallet connection via MetaMask, WalletConnect, Coinbase Wallet, and Rainbow
- **FR-005**: System MUST support four mainnet networks: Ethereum (1), Arbitrum (42161), Optimism (10), Polygon (137)
- **FR-006**: System MUST support four testnet networks when enabled: Sepolia (11155111), Arbitrum Sepolia (421614), Optimism Sepolia (11155420), Polygon Amoy (80002)
- **FR-007**: System MUST apply custom RainbowKit theme with Electric Violet (#7C3AED) accent color
- **FR-008**: System MUST display network-specific ambient theming (Ethereum violet, Arbitrum blue, Optimism red, Polygon purple)
- **FR-009**: System MUST show "TESTNET MODE" banner when connected to any testnet network
- **FR-010**: System MUST route all RPC calls through a single custom Wagmi HTTP transport that POSTs to `/api/rpc?chainId={id}`, with proxy handling provider selection
- **FR-011**: System MUST persist wallet connection state across page refreshes using Wagmi's `createStorage` with LocalStorage backend
- **FR-012**: System MUST prompt network switch when invoice network differs from connected network
- **FR-013**: System MUST display connected wallet address in truncated format (e.g., 0x1234...5678)
- **FR-014**: System MUST provide disconnect functionality accessible from wallet display
- **FR-015**: System MUST use environment variable `NEXT_PUBLIC_ENABLE_TESTNETS` to toggle testnet visibility
- **FR-016**: System MUST use separate RPC endpoints for mainnet vs testnet (via proxy configuration)
- **FR-017**: System MUST use environment variable `NEXT_PUBLIC_WALLETCONNECT_PROJECT_ID` for WalletConnect Cloud integration

### Key Entities

- **Network Configuration**: Chain ID, name, native currency, RPC endpoint reference, block explorer URL, theme colors
- **Wallet Connection State**: Connected status, address, current chain ID, connector type
- **RainbowKit Theme**: Custom color palette, accent color, border radius, font stack

## Success Criteria _(mandatory)_

### Measurable Outcomes

- **SC-001**: Users can connect their wallet in under 10 seconds after clicking "Connect Wallet"
- **SC-002**: Network switching completes within 5 seconds of user approval
- **SC-003**: 100% of RPC calls are routed through the proxy (no client-side key exposure)
- **SC-004**: Wallet connection persists across browser refresh without requiring re-authentication
- **SC-005**: All four mainnet networks are selectable and functional
- **SC-006**: Testnet banner is visible 100% of the time when on a testnet network
- **SC-007**: Theme colors update immediately upon network change (no visible delay)
- **SC-008**: System gracefully handles wallet rejection, disconnection, and unavailable providers

## Assumptions

- Users have a Web3-compatible browser or mobile wallet
- The existing `/api/rpc` proxy (P0.4) is operational and will be extended for Wagmi transport
- Design tokens for network themes are already defined in the design system (P0.6.5)
- The AppShell component (P0.6.6) provides the header location for wallet button

## Clarifications

### Session 2025-11-28

- Q: Which storage backend should Wagmi use for wallet connection persistence? → A: LocalStorage (via Wagmi `createStorage`), aligns with Constitutional Principle II and existing Zustand pattern
- Q: How should Wagmi integrate with the RPC proxy? → A: Single custom HTTP transport POSTing to `/api/rpc?chainId={id}`, proxy selects provider
- Q: Which Wagmi/RainbowKit versions to use? → A: Wagmi v2.x + RainbowKit v2.x (stable, production-ready); upgrade to v3 when RainbowKit releases compatible version
- Q: How should WalletConnect Project ID be configured? → A: Environment variable `NEXT_PUBLIC_WALLETCONNECT_PROJECT_ID`
